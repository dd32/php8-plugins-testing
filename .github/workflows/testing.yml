name: PHP8 Readiness.

on: repository_dispatch

jobs:
  run_tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Setup PHP & Composer
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'
        tools: composer
    - name: Setup Environment
      run: |
        composer install
        mkdir -p vendor/PHPCompatibility/PHPCompatibility
        git clone https://github.com/PHPCompatibility/PHPCompatibility vendor/PHPCompatibility/PHPCompatibility
        cd vendor/PHPCompatibility/PHPCompatibility && composer install
        php --version
    - name: Checkout Plugin
      run: |
        mkdir -p plugin
        svn export $SVN_DIR plugin --force
      env:
          SVN_DIR: "${{ github.event.client_payload.svn }}"
    - name: Run PHPCompatibility checks
      run: |
        ./phpcs.php
    -name: PHP 8 Linting
      run: find plugin -name "*.php" -not -name "*polyfill*" -print0 | xargs -P4 -0 -I% php -l %